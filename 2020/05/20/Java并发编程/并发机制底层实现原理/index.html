<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>并发机制底层实现原理 | 韬光养月巴的技术博客</title>
  <meta name="description" content="一、本地内存和线程安全问题  1、缓存行 CPU不会直接和内存(主存)交互，而是通过总线将数据读到自己的缓存行中。 缓存行:  缓存是分段（line）的，一个段对应一块存储空间，我们称之为缓存行； 它是CPU缓存中可分配的最小存储单元，通常来说是64字节； 当CPU看到一条读取内存的指令时，它会把内存地址传递给一级数据缓存，一级数据缓存会检查它是否有这个内存地址对应的缓存段，如果没有就把整个缓存">
<meta property="og:type" content="article">
<meta property="og:title" content="并发机制底层实现原理">
<meta property="og:url" content="http://blog.tgyf.com/2020/05/20/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/index.html">
<meta property="og:site_name" content="韬光养月巴的技术博客">
<meta property="og:description" content="一、本地内存和线程安全问题  1、缓存行 CPU不会直接和内存(主存)交互，而是通过总线将数据读到自己的缓存行中。 缓存行:  缓存是分段（line）的，一个段对应一块存储空间，我们称之为缓存行； 它是CPU缓存中可分配的最小存储单元，通常来说是64字节； 当CPU看到一条读取内存的指令时，它会把内存地址传递给一级数据缓存，一级数据缓存会检查它是否有这个内存地址对应的缓存段，如果没有就把整个缓存">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blog.tgyf.com/2020/05/20/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/1556199651448.png">
<meta property="og:image" content="http://blog.tgyf.com/2020/05/20/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/1556294370745.png">
<meta property="og:image" content="http://blog.tgyf.com/2020/05/20/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/1556294437788.png">
<meta property="og:image" content="http://blog.tgyf.com/2020/05/20/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/1556206913387.png">
<meta property="og:image" content="http://blog.tgyf.com/2020/05/20/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/1556242454279.png">
<meta property="article:published_time" content="2020-05-20T09:36:42.129Z">
<meta property="article:modified_time" content="2020-05-20T09:36:42.129Z">
<meta property="article:author" content="韬光养月巴">
<meta property="article:tag" content="Java并发编程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.tgyf.com/2020/05/20/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/1556199651448.png">
  <!-- Canonical links -->
  <link rel="canonical" href="http://blog.tgyf.com/2020/05/20/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/index.html">
  
    <link rel="alternate" href="/atom.xml" title="韬光养月巴的技术博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
    <link href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.css" rel="stylesheet">
  
  
<meta name="generator" content="Hexo 4.2.0"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/tgyf" target="_blank">
          <img class="img-circle img-rotate" src="/images/sw.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">韬光养月巴</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Java Developer &amp; Designer</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Chengdu, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">项目</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-books">
          <a href="/books">
            
            <i class="icon icon-book-fill"></i>
            
            <span class="menu-title">书单</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">友链</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/tgyf" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎访问韬光养月巴的技术博客</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Database/">Database</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JVM/">JVM</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%9F%BA%E7%A1%80/Java%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6/">Java集合框架</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">Java并发编程</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E6%A1%86%E6%9E%B6/">Java框架</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MQ/">MQ</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/RabbitMQ/">RabbitMQ</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringCloud/">SpringCloud</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2/">应用部署</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Database/" rel="tag">Database</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Eureka/" rel="tag">Eureka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gateway/" rel="tag">Gateway</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/" rel="tag">JVM</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" rel="tag">Java并发编程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6/" rel="tag">Java集合框架</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LinkedList/" rel="tag">LinkedList</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MQ/" rel="tag">MQ</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/" rel="tag">Mysql</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/" rel="tag">RabbitMQ</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloud/" rel="tag">SpringCloud</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/" rel="tag">一些思考</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%9A%E5%AE%A2/" rel="tag">博客</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/Database/" style="font-size: 13.83px;">Database</a> <a href="/tags/Eureka/" style="font-size: 13px;">Eureka</a> <a href="/tags/Gateway/" style="font-size: 13px;">Gateway</a> <a href="/tags/JVM/" style="font-size: 13.33px;">JVM</a> <a href="/tags/Java/" style="font-size: 13.83px;">Java</a> <a href="/tags/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" style="font-size: 13px;">Java并发编程</a> <a href="/tags/Java%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6/" style="font-size: 13px;">Java集合框架</a> <a href="/tags/LinkedList/" style="font-size: 13px;">LinkedList</a> <a href="/tags/MQ/" style="font-size: 14px;">MQ</a> <a href="/tags/Mysql/" style="font-size: 13.83px;">Mysql</a> <a href="/tags/RabbitMQ/" style="font-size: 13.5px;">RabbitMQ</a> <a href="/tags/SpringCloud/" style="font-size: 13.67px;">SpringCloud</a> <a href="/tags/%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/" style="font-size: 13.83px;">一些思考</a> <a href="/tags/%E5%8D%9A%E5%AE%A2/" style="font-size: 13.17px;">博客</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">16</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">6</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">Java并发编程</a>
              </p>
              <p class="item-title">
                <a href="/2020/05/20/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" class="title">并发机制底层实现原理</a>
              </p>
              <p class="item-date">
                <time datetime="2020-05-20T09:36:42.129Z" itemprop="datePublished">2020-05-20</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Database/">Database</a>
              </p>
              <p class="item-title">
                <a href="/2020/05/20/Mysql/Mysql%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F%20-%20%E4%B8%80%E6%9D%A1SQL%E6%9B%B4%E6%96%B0%E8%AF%AD%E5%8F%A5%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E7%9A%84/" class="title">Mysql日志系统 - 一条SQL更新语句是如何执行的</a>
              </p>
              <p class="item-date">
                <time datetime="2020-05-20T09:06:27.075Z" itemprop="datePublished">2020-05-20</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Database/">Database</a>
              </p>
              <p class="item-title">
                <a href="/2020/05/20/Mysql/Mysql%E6%9E%B6%E6%9E%84%20-%20%E4%B8%80%E6%9D%A1SQL%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E7%9A%84/" class="title">Mysql架构 - 一条SQL查询语句是如何执行的</a>
              </p>
              <p class="item-date">
                <time datetime="2020-05-20T08:59:12.810Z" itemprop="datePublished">2020-05-20</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Database/">Database</a>
              </p>
              <p class="item-title">
                <a href="/2020/05/20/Mysql/Mysql%E7%B4%A2%E5%BC%95-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%B4%A2%E5%BC%95(%E4%BA%8C)/" class="title">Mysql索引-深入浅出索引(二)</a>
              </p>
              <p class="item-date">
                <time datetime="2020-05-20T08:55:25.491Z" itemprop="datePublished">2020-05-20</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Database/">Database</a>
              </p>
              <p class="item-title">
                <a href="/2020/05/20/Mysql/Mysql%E7%B4%A2%E5%BC%95-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%B4%A2%E5%BC%95(%E4%B8%80)/" class="title">Mysql索引-深入浅出索引(一)</a>
              </p>
              <p class="item-date">
                <time datetime="2020-05-20T08:53:38.171Z" itemprop="datePublished">2020-05-20</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse in" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar" aria-expanded="true">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一-本地内存和线程安全问题"><span class="toc-number">1.</span> <span class="toc-text"> 一、本地内存和线程安全问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-缓存行"><span class="toc-number">1.1.</span> <span class="toc-text"> 1、缓存行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-写缓冲区"><span class="toc-number">1.2.</span> <span class="toc-text"> 2、写缓冲区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-线程安全问题"><span class="toc-number">1.3.</span> <span class="toc-text"> 3、线程安全问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二-volatile实现原理"><span class="toc-number">2.</span> <span class="toc-text"> 二、volatile实现原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-volatile语义"><span class="toc-number">2.1.</span> <span class="toc-text"> 1、volatile语义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-lock前缀指令"><span class="toc-number">2.2.</span> <span class="toc-text"> 2、Lock前缀指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-缓存一致性"><span class="toc-number">2.3.</span> <span class="toc-text"> 3、缓存一致性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-回看volatile原理"><span class="toc-number">2.4.</span> <span class="toc-text"> 4、回看volatile原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三-sychronized实现原理"><span class="toc-number">3.</span> <span class="toc-text"> 三、sychronized实现原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-monitor"><span class="toc-number">3.1.</span> <span class="toc-text"> 1、Monitor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-java对象头"><span class="toc-number">3.2.</span> <span class="toc-text"> 2、Java对象头</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-锁的升级"><span class="toc-number">3.3.</span> <span class="toc-text"> 3、锁的升级</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四-原子操作实现原理"><span class="toc-number">4.</span> <span class="toc-text"> 四、原子操作实现原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-处理器实现原子操作"><span class="toc-number">4.1.</span> <span class="toc-text"> 1、处理器实现原子操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-java实现原子操作"><span class="toc-number">4.2.</span> <span class="toc-text"> 2、Java实现原子操作</span></a></li></ol></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Java并发编程/并发机制底层实现原理" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      并发机制底层实现原理
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2020/05/20/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" class="article-date">
	  <time datetime="2020-05-20T09:36:42.129Z" itemprop="datePublished">2020-05-20</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">Java并发编程</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link" href="/tags/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" rel="tag">Java并发编程</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2020/05/20/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/#comments" class="article-comment-link">评论</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h2 id="一-本地内存和线程安全问题"><a class="markdownIt-Anchor" href="#一-本地内存和线程安全问题"></a> 一、本地内存和线程安全问题</h2>
<h3 id="1-缓存行"><a class="markdownIt-Anchor" href="#1-缓存行"></a> 1、缓存行</h3>
<p>CPU不会直接和内存(主存)交互，而是通过总线将数据读到自己的缓存行中。</p>
<p>缓存行:</p>
<ul>
<li>缓存是分段（line）的，一个段对应一块存储空间，我们称之为缓存行；</li>
<li>它是CPU缓存中可分配的最小存储单元，通常来说是64字节；</li>
<li>当CPU看到一条读取内存的指令时，它会把内存地址传递给一级数据缓存，一级数据缓存会检查它是否有这个内存地址对应的缓存段，如果没有就把整个缓存段从内存（或更高一级的缓存）中加载进来；</li>
</ul>
<h3 id="2-写缓冲区"><a class="markdownIt-Anchor" href="#2-写缓冲区"></a> 2、写缓冲区</h3>
<p>CPU不会直接和内存(主存)交互，会将要读取的数据先写入到自己的写缓冲区，随后才会刷新到内存。</p>
<h3 id="3-线程安全问题"><a class="markdownIt-Anchor" href="#3-线程安全问题"></a> 3、线程安全问题</h3>
<ul>
<li>实际中都是由很多CPU来执行并发程序，不同处理器同时执行不同的线程（每个线程都有一个仅对执行自己的处理器可见的本地内存)；</li>
<li>所以就会出现主内存中<code>i = 1</code>，线程A读取到自己的本地内存<code>i++</code>，于此同时线程B也读取到主内存<code>i= 1</code>到自己的本地内存执行<code>i++</code>，待两个线程的本地内存刷新到主内存时<code>i = 2</code>。于是引发了线程安全问题。</li>
</ul>
<img src="/2020/05/20/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/1556199651448.png" class width="1556199651448">
<p>线程安全问题总结:</p>
<ul>
<li><strong>线程都是在自己的本地内存中操作共享变量的，仅对执行自己的处理器可见而对其他处理器不可见</strong>。</li>
<li>而它们在自己的本地内存对共享变量的更新何时会刷新到主内存、会按照什么顺序刷新到主内存是不可预见的。</li>
</ul>
<h2 id="二-volatile实现原理"><a class="markdownIt-Anchor" href="#二-volatile实现原理"></a> 二、volatile实现原理</h2>
<p>总结:</p>
<ul>
<li>对于声明了<code>volatile</code>的变量进行写操作的时候，JVM会向处理器发送一条LOCK前缀的指令。<strong>会把这个变量所在缓存行的数据写回到主内存中</strong>；</li>
<li>在多处理器的情况下，保证各个<strong>处理器缓存一致性的特点，实现缓存一致性协议</strong>；</li>
</ul>
<p>通过加入<strong>内存屏障</strong>和<strong>禁止重排序优化</strong>实现。</p>
<ul>
<li>对volatile变量写操作时，会在写操作后面加入一条<code>store</code>屏障指令，将本地内存中的共享变量值刷新到主内存；</li>
<li>对volatile变量读操作时，会在读操作前加入一条load屏障指令，从主内存中读取共享变量；</li>
</ul>
<img src="/2020/05/20/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/1556294370745.png" class width="1556294370745">
<img src="/2020/05/20/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/1556294437788.png" class width="1556294437788">
<h3 id="1-volatile语义"><a class="markdownIt-Anchor" href="#1-volatile语义"></a> 1、volatile语义</h3>
<p>使用volatile关键字可以<strong>保证共享变量之间的可见性</strong>，被<code>volatile</code>修饰的变量在线程之间就是可见的，能保证变量被一致性的更新。</p>
<p><code>volatile</code>做的两件事:</p>
<ul>
<li>1、锁定缓存行；
<ul>
<li>在某个处理器将共享数据写入自己的缓冲区 (对应线程对本地内存中的共享记量做修改) 时，<strong>会使用缓存锁定其他也读取了该共享记量的缓存行，使其他处理器不能访问该共享专量</strong>。</li>
<li>早期使用的是总线锁定，即一经锁定，其他处理器就不能访问所有共享记量，但是这会影响处理器读写其他共享变量，影响效率。</li>
</ul>
</li>
<li>2、刷新内存，保证数据一致性；
<ul>
<li>该处理器将自己写缓冲区中的所有数据刷新到主内存 (包括非volatile变量) 。</li>
<li>由<strong>缓存一致性协议</strong>来保证其他CPU重新读数据 (其他处理器会通过总线嗅探其他处理器写组冲区中的更改，一经发现就会将自己的缓存行置为无效状态(看自己的是不是过期了)，下次访问数据时需要到主内存中重新读)</li>
</ul>
</li>
</ul>
<p>一旦一个共享变量（类的成员变量、类的静态成员变量）被<code>volatile</code>修饰之后，那么就具备了两层语义：</p>
<ul>
<li>1、保证了不同线程对这个变量进行操作时的可见性，即一个线程修改了某个变量的值，这新值对其他线程来说是立即可见的。</li>
<li>2、<strong>禁止进行指令重排序</strong>。</li>
</ul>
<blockquote>
<p>由于缓存行为<code>32</code>字节宽或者<code>64</code>字节宽，因此避免缓存锁定多个共享资源，可以采用<strong>字节填充</strong>的方式来提高对象并发性能。</p>
</blockquote>
<h3 id="2-lock前缀指令"><a class="markdownIt-Anchor" href="#2-lock前缀指令"></a> 2、Lock前缀指令</h3>
<p>加入volatile关键字和没有加入volatile关键字时所生成的汇编代码发现，<strong>加入volatile关键字时，会多出一个lock前缀指令</strong></p>
<p>lock前缀指令实际上相当于一个<strong>内存屏障</strong>（也称内存栅栏），内存屏障会提供3个功能：</p>
<ul>
<li>1、它确保指令重排序时<strong>不会把其后面的指令排到内存屏障之前的位置</strong>，也不会把前面的指令排到内存屏障的后面；即在执行到内存屏障这句指令时，在它前面的操作已经全部完成；</li>
<li>2、<strong>它会强制将对缓存的修改操作立即写入主存</strong>；</li>
<li>3、如果是写操作，它会导致其他CPU(处理器)中对应的缓存行无效。</li>
</ul>
<p>在JVM底层volatile是采用“内存屏障”来实现的。</p>
<p>可以得出lock指令的几个作用：</p>
<ul>
<li>1、锁总线，其它CPU对内存的读写请求都会被阻塞，直到锁释放，不过实际后来的处理器都采用锁缓存替代锁总线，因为锁总线的开销比较大，锁总线期间其他CPU没法访问内存</li>
<li>2、lock后的写操作会<strong>回写已修改的数据，同时让其它CPU相关缓存行失效</strong>，从而重新从主存中加载最新的数据</li>
<li>3、不是内存屏障却能完成类似内存屏障的功能，阻止屏障两遍的指令重排序</li>
</ul>
<p>这种场景下多缓存的数据一致是通过缓存一致性协议来保证的，我们来看一下什么是缓存一致性协议。</p>
<h3 id="3-缓存一致性"><a class="markdownIt-Anchor" href="#3-缓存一致性"></a> 3、缓存一致性</h3>
<p><code>LOCK#</code>会锁总线，实际上这不现实，因为锁总线效率太低了。因此最好能做到：使用多组缓存，但是它们的行为看起来只有一组缓存那样。缓存一致性协议就是为了做到这一点而设计的，就像名称所暗示的那样，<strong>这类协议就是要使多组缓存的内容保持一致</strong>。</p>
<p>缓存一致性协议有多种，但是日常处理的大多数计算机设备都属于&quot;嗅探（snooping）&quot;协议，基本思想如下:</p>
<ul>
<li>所有内存的传输都发生在一条共享的总线上，而所有的处理器都能看到这条总线：缓存本身是独立的，但是内存是共享资源，所有的内存访问都要经过仲裁（同一个指令周期中，只有一个CPU缓存可以读写内存）。</li>
<li>CPU缓存不仅仅在做内存传输的时候才与总线打交道，<strong>而是不停在嗅探总线上发生的数据交换，跟踪其他缓存在做什么。所以当一个缓存代表它所属的处理器去读写内存时，其它处理器都会得到通知，它们以此来使自己的缓存保持同步</strong>。只要某个处理器一写内存，其它处理器马上知道这块内存在它们的缓存段中已<strong>失效</strong>。</li>
</ul>
<h3 id="4-回看volatile原理"><a class="markdownIt-Anchor" href="#4-回看volatile原理"></a> 4、回看volatile原理</h3>
<img src="/2020/05/20/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/1556206913387.png" class width="1556206913387">
<p>工作内存Work Memory其实就是对CPU寄存器和高速缓存的抽象，或者说每个线程的工作内存也可以简单理解为CPU寄存器和高速缓存。</p>
<p>那么当写两条线程<code>Thread-A</code>与<code>Threab-B</code>同时操作主存中的一个volatile变量<code>i</code>时，Thread-A写了变量<code>i</code>，那么：</p>
<ul>
<li><code>Thread-A</code>发出<code>LOCK#</code>指令</li>
<li>发出的<code>LOCK#</code>指令锁总线（或锁缓存行），同时让<code>Thread-B</code>高速缓存中的缓存行内容失效</li>
<li><code>Thread-A</code>向主存回写最新修改的<code>i</code></li>
</ul>
<p><code>Thread-B</code>读取变量<code>i</code>，那么：</p>
<ul>
<li><code>Thread-B</code>发现对应地址的缓存行被锁了，等待锁的释放，缓存一致性协议会保证它读取到最新的值</li>
</ul>
<p>由此可以看出，volatile关键字的读和普通变量的读取相比基本没差别，差别主要还是在变量的写操作上。</p>
<h2 id="三-sychronized实现原理"><a class="markdownIt-Anchor" href="#三-sychronized实现原理"></a> 三、sychronized实现原理</h2>
<h3 id="1-monitor"><a class="markdownIt-Anchor" href="#1-monitor"></a> 1、Monitor</h3>
<p>利用synchronized实现同步的基础，Java中的每一个对象都可以作为锁，有以下3种形式</p>
<ul>
<li>对于普通同步方法，锁是当前实例对象；</li>
<li>对于静态同步方法，锁是当前类的Class对象；</li>
<li>对于同步方法块，锁住的是synchonized括号里配置的对象；</li>
</ul>
<p>Java 虚拟机中的同步(Synchronization)是基于进入和退出<strong>Monitor对象</strong>实现， <strong>无论是显式同步(有明确的 monitorenter 和 monitorexit 指令</strong>，即同步代码块)还是隐式同步都是如此。</p>
<p><code>monitorenter</code>指令实在编译后插入到同步代码块的开始位置，而<code>monitorexit</code>是插入到方法结束和异常处，每个<code>monitorenter</code>必须要有对应的额<code>monitorexit</code>与之配对，任何对象都有<code>monitor</code>与之关联。</p>
<p>线程只有持有到<code>monitor</code>，才会属于锁定状态，线程会尝试获取对象对应的<code>monitor</code>的所有权，即尝试获得对象的锁。</p>
<p>在 Java 语言中，同步用的最多的地方可能是被 synchronized 修饰的同步方法。<strong>同步方法并不是由monitorenter 和 monitorexit 指令来实现同步的，而是由方法调用指令读取运行时常量池中方法的 ACC_SYNCHRONIZED 标志来隐式实现的</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Object obj)</span></span>&#123;</span><br><span class="line"><span class="number">2</span>        <span class="keyword">synchronized</span> (obj)&#123;</span><br><span class="line"><span class="number">3</span>            <span class="comment">//do something</span></span><br><span class="line"><span class="number">4</span>        &#125;</span><br><span class="line"><span class="number">5</span>    &#125;</span><br><span class="line"></span><br><span class="line">反编译后：</span><br><span class="line"> <span class="number">1</span><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">zxin</span>.<span class="title">thread</span>.<span class="title">SynchronizedDemo</span> </span>&#123;</span><br><span class="line"> <span class="number">2</span>  <span class="keyword">public</span> com.wuzy.thread.SynchronizedDemo();</span><br><span class="line"> <span class="number">3</span>    Code:</span><br><span class="line"> <span class="number">4</span>       <span class="number">0</span>: aload_0</span><br><span class="line"> 5       1: invokespecial #1              </span><br><span class="line"> <span class="number">6</span>       <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line"> <span class="number">7</span></span><br><span class="line"> <span class="number">8</span>  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(java.lang.Object)</span></span>;</span><br><span class="line"> <span class="number">9</span>    Code:</span><br><span class="line"><span class="number">10</span>       <span class="number">0</span>: aload_1</span><br><span class="line"><span class="number">11</span>       <span class="number">1</span>: dup</span><br><span class="line"><span class="number">12</span>       <span class="number">2</span>: astore_2</span><br><span class="line"><span class="number">13</span>       <span class="number">3</span>: monitorenter <span class="comment">//进入同步方法</span></span><br><span class="line"><span class="number">14</span>       <span class="number">4</span>: aload_2</span><br><span class="line"><span class="number">15</span>       <span class="number">5</span>: monitorexit <span class="comment">//退出同步方法</span></span><br><span class="line"><span class="number">16</span>       <span class="number">6</span>: goto          <span class="number">14</span></span><br><span class="line"><span class="number">17</span>       <span class="number">9</span>: astore_3</span><br><span class="line"><span class="number">18</span>      <span class="number">10</span>: aload_2</span><br><span class="line"><span class="number">19</span>      <span class="number">11</span>: monitorexit <span class="comment">//退出同步方法</span></span><br><span class="line"><span class="number">20</span>      <span class="number">12</span>: aload_3</span><br><span class="line"><span class="number">21</span>      <span class="number">13</span>: athrow</span><br><span class="line"><span class="number">22</span>      <span class="number">14</span>: <span class="keyword">return</span></span><br><span class="line"><span class="number">23</span>    Exception table:</span><br><span class="line"><span class="number">24</span>       from    to  target type</span><br><span class="line"><span class="number">25</span>           <span class="number">4</span>     <span class="number">6</span>     <span class="number">9</span>   any</span><br><span class="line"><span class="number">26</span>           <span class="number">9</span>    <span class="number">12</span>     <span class="number">9</span>   any</span><br><span class="line"><span class="number">27</span>&#125;</span><br></pre></td></tr></table></figure>
<p>看下第13行~15行代码**，发现同步代码块是使用monitorenter和monitorexit指令来进行代码同步的,注意看第19行代码，为什么会多出一个monitorexit指令，主要是JVM为了防止代码出现异常**，也能正确退出同步方法。</p>
<p>同步方法并不是用<code>monitorenter</code>和<code>monitorexit</code>指令来进行同步的，实际上同步方法会被翻译成普通的方法调用和返回指令如:invokevirtual、areturn指令，在VM字节码层面并没有任何特别的指令来实现被synchronized修饰的方法，而是<strong>在Class文件的方法表中将该方法的access_flags字段中的synchronized标志位置设为1</strong>，表示该方法是同步方法并使用调用该方法的对象或该方法所属的Class在JVM的内部对象表示做为锁对象。</p>
<p>总结:</p>
<ul>
<li>同步代码块: 使用<code>monitorenter</code>和<code>monitorexit</code>；</li>
<li>同步方法: 使用方法修饰符<code>ACC_ASYNCHRONIZED</code>。</li>
</ul>
<h3 id="2-java对象头"><a class="markdownIt-Anchor" href="#2-java对象头"></a> 2、Java对象头</h3>
<p>在JVM内存中，对象在内存中的布局分为<code>3</code>块: <strong>对象头、实例数据和对其填充</strong>。</p>
<p>其中对象头包括 : <code>Mark Word、Class Meta Data、Array Length</code>。</p>
<ul>
<li><code>Mark Word</code>: 锁标志位等跟锁有关的信息，2个字节存储(数组则3个)；</li>
<li><code>Class Meta Data</code>: 对象所属类的类元数据信息；</li>
<li><code>Array Length</code> : 对象为数组类型时才有，记录了数组长度；</li>
</ul>
<p>Mark Word的状态变化:</p>
<img src="/2020/05/20/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/1556242454279.png" class width="1556242454279">
<p>锁标志的意义:</p>
<ul>
<li>锁标识<code>lock == 00</code>标识轻量级锁；</li>
<li>锁标识<code>lock = 10</code>标识重量级锁；</li>
<li>偏向锁标识<code>biased_lock = 1</code>表示偏向锁；</li>
<li>偏向锁标识<code>biased_lock = 0</code>且锁标识<code>=01</code>表示无锁状态；</li>
</ul>
<h3 id="3-锁的升级"><a class="markdownIt-Anchor" href="#3-锁的升级"></a> 3、锁的升级</h3>
<p>锁的状态: <strong>无锁、偏向锁、轻量级锁、重量级锁</strong>。</p>
<p>锁升级: <strong>JVM检测到不同的竞争状态时，自动切换到合适的锁实现</strong>。</p>
<p><strong>无锁</strong>:</p>
<ul>
<li>初始情况(没有任何线程访问过同步块)；</li>
</ul>
<p><strong>偏向锁</strong>:</p>
<ul>
<li>大多数场景不会出现多线程并发访问共享资源的情况，针对并发强度小的情况，引入了偏向锁，在一个线程访问同步块时有如下操作:
<ul>
<li>1、判断对象头的<code>Mark Word</code>中的线程ID是否指的就是当前线程，如果是，直接进入同步块，如果不是，进入步骤<code>2</code>；</li>
<li>2、如果对象头的<code>Mark Word</code>中的线程ID不是指向当前线程，那么查看Mark Word中&quot;是否是偏向锁&quot;这一标志位。如果是<code>1</code>，指向步骤<code>3</code>；否则表示是无锁状态，CAS将Mard Word 中的线程ID指向当前线程，进入同步块；</li>
<li>3、如果是<code>1</code>就说明是偏向锁，而且出现了锁争用的情况，偏向锁升级为轻量级锁；</li>
</ul>
</li>
<li>偏向锁撤销
<ul>
<li>由于偏向锁是&quot;偏向&quot;某一个线程的，如果线程&quot;挂了&quot;怎么办？这就需要偏向锁撤销机制；</li>
<li>即在一个安全点（没有字节码执行），首先暂停锁&quot;偏向&quot;的线程，然后检查线程状态，如果线程&quot;挂了&quot;那么将锁置为无锁状态；</li>
</ul>
</li>
</ul>
<p><strong>轻量级锁</strong>:</p>
<ul>
<li>获取锁
<ul>
<li>1、首先将同步对象(synchronize内的对象)的Mark Word复制一份到当前线程栈桢的一块空间中，并使用CAS将同步对象的Mark Word更新为指向该空间的指针，如果更新成功那么成功获取锁；否则CAS自旋；</li>
<li>2、获取锁的线程在执行完同步块释放锁时，CAS将同步对象的Mark Word替换回占中原先保存的Mark Word，如果成功，则表示成功释放锁，没有竞争发生。否则表明当前锁存在竞争，升级为重量级锁；</li>
</ul>
</li>
</ul>
<p><strong>重量级锁(排他锁)</strong>:</p>
<ul>
<li>想进入同步快需要获取对象的<code>monitor</code>，退出时释放<code>monitor</code>。</li>
<li>获取对象<code>monitor</code>时如果<code>monitor</code>已被持有，则该线程将进入<code>monitor</code>的阻塞队列，直到<code>monitor</code>被释放，<code>monitor</code>阻塞队列上的线程将开启一轮新的竞争。</li>
</ul>
<h2 id="四-原子操作实现原理"><a class="markdownIt-Anchor" href="#四-原子操作实现原理"></a> 四、原子操作实现原理</h2>
<h3 id="1-处理器实现原子操作"><a class="markdownIt-Anchor" href="#1-处理器实现原子操作"></a> 1、处理器实现原子操作</h3>
<p>1、使用总线锁保证原子性</p>
<p>所谓总线锁就是使用处理器提供的一个<code>LOCK＃</code>信号，当一个处理器在总线上输出此信号时，其他处理器的请求将被阻塞住，那么该处理器可以独占使用共享内存。</p>
<p>2、使用缓存锁保证原子性</p>
<p>所谓“<strong>缓存锁定</strong>”就是如果缓存在处理器缓存行中内存区域在LOCK操作期间被锁定，当它执行锁操作回写内存时，处理器不在总线上声言<code>LOCK＃</code>信号，<strong>而是修改内部的内存地址，并允许它的缓存一致性机制</strong>来保证操作的原子性；</p>
<h3 id="2-java实现原子操作"><a class="markdownIt-Anchor" href="#2-java实现原子操作"></a> 2、Java实现原子操作</h3>
<p>两种方式：<strong>锁和循环CAS</strong></p>
<p>CAS全称<code>Compare-and-Swap</code>（比较并交换），JVM中的CAS操作是依赖处理器提供的<code>cmpxchg</code>指令完成的，CAS指令中有3个操作数，分别是内存位置V、旧的预期值A和新值B。</p>
<p>当CAS指令执行时，<strong>当且仅当内存位置V符合旧预期值时A时，处理器才会用新值B去更新V的值，否则就不执行更新，但是无论是否更新V，都会返回V的旧值，该操作过程就是一个原子操作</strong></p>
<p>JDK1.5之后才可以使用CAS，由<code>sun.misc.Unsafe</code>类里面的<code>compareAndSwapInt()</code>和<code>compareAndSwapLong()</code>等方法包装实现，虚拟机在即时编译时，对这些方法做了特殊处理，会编译出一条相关的处理器CAS指令</p>
<blockquote>
<p>CAS就是Compare And Swap，涉及到两个术语: 预期值、更新值。在对内存中的值进行更新时，拿A和B两线程同时对<code>i</code>变量进行<code>i++</code>举例:</p>
<p>首先A线程读到<code>i</code>的值为1，执行<code>i++</code>操作并刷新到主内存时，比较一下主内存中的还是不是1 (预期值) ，如果是就将共享记量替换为2 (更新值) 。</p>
<p>后来B也准备将<code>i= 2</code>刷新到主内存时，发现主内存中的不等于1 (预期值) ，于是更新失败，重新读取<code>i=2</code>，进行CAS更新，这个不断尝试CAS更新的过程称为自旋。</p>
</blockquote>
<p><strong>CAS实现原子操作的三大问题</strong></p>
<p><strong>1、ABA问题</strong>：初次读取内存旧值时是A，再次检查之前这段期间，如果内存位置的值发生过从A变成B再变回A的过程，我们就会错误的检查到旧值还是A，认为没有发生变化，其实已经发生过A-B-A得变化，这就是CAS操作的ABA问题</p>
<p>解决方法：使用版本号，即<code>1A-2B-3A</code>，这样就会发现1A到3A的变化，不存在ABA变化无感知问题，JDK的atomic包中提供一个带有标记的原子引用类<code>AtomicStampedReference</code>来解决ABA问题</p>
<p><strong>2、循环时间长开销大</strong>：自旋CAS如果长时间不成功，会给CPU带来非常大的执行开销</p>
<p><strong>3、只能保证一个共享变量的原子操作</strong>：当对一个共享变量执行操作时，可以使用循环CAS来保证原子操作，但是多个共享变量操作时，就无法保证了</p>
<p>解决方法：</p>
<ul>
<li>将多个变量<strong>组合成一个共享变量</strong>，jdk提供了<code>AtomicReference</code>类来保证引用对象之间的原子性，那么就可以把多个变量放在一个对象里来进行CAS操作</li>
<li>使用锁</li>
</ul>
<blockquote>
<p>除了偏向锁，JVM实现锁的方式都用了循环CAS，即当一个线程想进入同步块的时候使用循环CAS的方式来获取锁，当它退出同步块的时候使用循环CAS释放锁。</p>
</blockquote>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      </br><a href="http://blog.tgyf.com/2020/05/20/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" title="并发机制底层实现原理" target="_blank" rel="external">http://blog.tgyf.com/2020/05/20/Java并发编程/并发机制底层实现原理/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong>
      </br>本博客所有文章除特别声明外，均采用 知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议 许可协议。转载请注明出处
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/tgyf" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/sw.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/tgyf" target="_blank"><span class="text-dark">韬光养月巴</span><small class="ml-1x">Java Developer &amp; Designer</small></a></h3>
        <div>勿在浮沙筑高台,不为繁华易匠心.</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    
    <li class="next">
      <a href="/2020/05/20/Mysql/Mysql%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F%20-%20%E4%B8%80%E6%9D%A1SQL%E6%9B%B4%E6%96%B0%E8%AF%AD%E5%8F%A5%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E7%9A%84/" title="Mysql日志系统 - 一条SQL更新语句是如何执行的"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>感谢您的支持，我会继续努力的!</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/tgyf" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   




   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: '',
    appKey: '',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     



  <script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.js"></script>
  <script>
  //利用 FancyBox 实现点击图片放大
  $(document).ready(function() {
    $('article img').not('[hidden]').not('.panel-body img').each(function() {
      var $image = $(this);
      var imageCaption = $image.attr('alt');
      var $imageWrapLink = $image.parent('a');
      if ($imageWrapLink.length < 1) {
        var src = this.getAttribute('src');
        var idx = src.lastIndexOf('?');
        if (idx != -1) {
          src = src.substring(0, idx);
        }
        $imageWrapLink = $image.wrap('<a href="' + src + '"></a>').parent('a');
      }
      $imageWrapLink.attr('data-fancybox', 'images');
      if (imageCaption) {
        $imageWrapLink.attr('data-caption', imageCaption);
      }
    });
    $().fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
    });
  });
  </script>





</body>
</html>